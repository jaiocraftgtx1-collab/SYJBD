@{
    // Roles
    bool isAdmin = User.IsInRole("ADMINISTRADOR");
    bool isCom = User.IsInRole("COMERCIAL");

    // Ruta actual
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "").ToLower();
    var act = (ViewContext.RouteData.Values["action"]?.ToString() ?? "").ToLower();

    // Helpers de estado activo/expandido
    Func<string, string?, string> active = (c, a) =>
        ctrl == c.ToLower() && (a == null || act == a.ToLower()) ? "active" : "";

    Func<string[], bool> sectionOpen = (controllers) =>
        controllers.Select(x => x.ToLower()).Contains(ctrl);

    // Grupos de controladores por sección
    var ventasCtrls = new[] { "ventas", "clientes" };
    var gastosCtrls = new[] { "gastos" };
    var productosCtrls = new[] { "productos", "categorias", "tallastipo", "tipos", "unidades", "dimensiones" };
}

<nav class="sidebar" id="sidebar" aria-label="Navegación principal">
    <div class="logo">
        <i class="bi bi-box"></i><span>TIENDA - S&J STYLE</span>
    </div>

    <!-- PANEL -->
    <div class="nav-section">
        <div class="nav-title">Panel</div>
        <a class="nav-link @active("home", "index")" asp-controller="Home" asp-action="Index">
            <i class="bi bi-speedometer2"></i><span>Dashboard</span>
        </a>
    </div>

    <!-- VENTAS -->
    @{
        bool ventasOpen = sectionOpen(ventasCtrls);
    }
    <div class="nav-section @(ventasOpen ? "open" : "")" data-section="ventas">
        <button class="nav-btn" type="button" aria-expanded="@(ventasOpen ? "true" : "false")">
            <span class="left"><i class="bi bi-bag"></i><span>Ventas</span></span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="nav-sub" style="@(ventasOpen ? "" : "display:none")">
            <a class="nav-link @active("ventas", "puntodeventa")" asp-controller="Ventas" asp-action="PuntoDeVenta">
                <i class="bi bi-basket"></i><span>Punto de venta</span>
            </a>
            <a class="nav-link @active("ventas", "index")" asp-controller="Ventas" asp-action="Index">
                <i class="bi bi-table"></i><span>Lista de ventas</span>
            </a>
            @if (isAdmin)
            {
                <a class="nav-link @active("clientes", "index")" asp-controller="Clientes" asp-action="Index">
                    <i class="bi bi-people"></i><span>Clientes</span>
                </a>
            }
        </div>
    </div>

    <!-- GASTOS -->
    @{
        bool gastosOpen = sectionOpen(gastosCtrls);
    }
    <div class="nav-section @(gastosOpen ? "open" : "")" data-section="gastos">
        <button class="nav-btn" type="button" aria-expanded="@(gastosOpen ? "true" : "false")">
            <span class="left"><i class="bi bi-cash-stack"></i><span>Gastos</span></span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="nav-sub" style="@(gastosOpen ? "" : "display:none")">
            @if (isCom)
            {
                <a class="nav-link @active("gastos", "index")" asp-controller="Gastos" asp-action="Index">
                    <i class="bi bi-card-checklist"></i><span>Lista de gastos</span>
                </a>
            }
            @if (isAdmin)
            {
                <a class="nav-link @active("gastos", "index")" asp-controller="Gastos" asp-action="Index">
                    <i class="bi bi-card-checklist"></i><span>Egresos</span>
                </a>
                <a class="nav-link @active("gastos", "autorizar")" asp-controller="Gastos" asp-action="Autorizar">
                    <i class="bi bi-check2-circle"></i><span>Autorizar gastos</span>
                </a>
                <a class="nav-link @active("gastos", "asignacion")" asp-controller="Gastos" asp-action="Asignacion">
                    <i class="bi bi-diagram-3"></i><span>Asignación gastos</span>
                </a>
            }
        </div>
    </div>

    <!-- PRODUCTOS -->
    @{
        bool productosOpen = sectionOpen(productosCtrls);
    }
    <div class="nav-section @(productosOpen ? "open" : "")" data-section="productos">
        <button class="nav-btn" type="button" aria-expanded="@(productosOpen ? "true" : "false")">
            <span class="left"><i class="bi bi-box-seam"></i><span>Productos</span></span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="nav-sub" style="@(productosOpen ? "" : "display:none")">
            <a class="nav-link @active("productos", "index")" asp-controller="Productos" asp-action="Index">
                <i class="bi bi-list-ul"></i><span>Lista de productos</span>
            </a>
            @if (isAdmin)
            {
                <a class="nav-link @active("productos", "tallasprecios")" asp-controller="Productos" asp-action="TallasPrecios">
                    <i class="bi bi-sliders"></i><span>Tallas y precios</span>
                </a>
                <a class="nav-link @active("categorias", "index")" asp-controller="Categorias" asp-action="Index">
                    <i class="bi bi-layers"></i><span>Categoría / Subcategorías</span>
                </a>
                <a class="nav-link @active("tallastipo", "index")" asp-controller="TallasTipo" asp-action="Index">
                    <i class="bi bi-grid-3x3"></i><span>Tallas por tipo</span>
                </a>
                <a class="nav-link @active("tipos", "index")" asp-controller="Tipos" asp-action="Index">
                    <i class="bi bi-box"></i><span>Tipo de productos</span>
                </a>
                <a class="nav-link @active("unidades", "index")" asp-controller="Unidades" asp-action="Index">
                    <i class="bi bi-rulers"></i><span>Unidades</span>
                </a>
                <!-- Si ya trabajas Dimensiones, queda listo -->
                <a class="nav-link @active("dimensiones", "index")" asp-controller="Dimensiones" asp-action="Index">
                    <i class="bi bi-aspect-ratio"></i><span>Dimensiones</span>
                </a>
            }
        </div>
    </div>

    <!-- SALIR -->
    <div class="nav-section">
        <a class="nav-link" asp-controller="Auth" asp-action="Logout" data-confirm="¿Deseas salir del sistema?">
            <i class="bi bi-box-arrow-right"></i><span>Salir</span>
        </a>
    </div>
</nav>
