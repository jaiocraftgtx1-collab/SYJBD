@model SYJBD.Models.PagedResult<SYJBD.Models.Producto>

@{
    ViewData["Title"] = "Productos";

    // Query actual: primero lo que venga en el modelo, si no, desde la querystring ?q=
    var q = Model?.Query;
    if (string.IsNullOrWhiteSpace(q))
    {
        q = ViewContext?.HttpContext?.Request?.Query["q"].ToString() ?? "";
    }

    // Atajos null-safe para no romper el render si algo viene en null
    var currentPage = Model?.Page ?? 1;
    var totalPages = Model?.TotalPages ?? 1;
    var totalItems = Model?.TotalItems ?? 0;
    var items = Model?.Items ?? new List<SYJBD.Models.Producto>();
    var hasPrev = Model?.HasPrev ?? (currentPage > 1);
    var hasNext = Model?.HasNext ?? (currentPage < totalPages);
}

<div class="card">
    <!-- CABECERA -->
    <div class="card-header">
        <h2 class="card-title">@ViewData["Title"]</h2>

        <!-- Buscador (Enter filtra; vacío = lista todo) -->
        <form asp-controller="Productos" asp-action="Index" method="get" class="search" role="search">
            <i class="bi bi-search" aria-hidden="true"></i>
            <input type="search"
                   name="q"
                   value="@q"
                   placeholder="Buscar por nombre y Enter"
                   autocomplete="off"
                   aria-label="Buscar productos por nombre" />
            <input type="hidden" name="page" value="1" />  @* siempre vuelve a página 1 *@
        </form>
    </div>

    <!-- TABLA -->
    <div class="table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Categoría</th>
                    <th scope="col">Unidad</th>
                    <th scope="col">Origen</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Creado</th>
                </tr>
            </thead>

            <tbody>
                @if (!items.Any())
                {
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            No hay resultados.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var p in items)
                    {
                        <tr>
                            <td data-label="ID">@p.IdProducto</td>
                            <td data-label="Nombre" class="col-nombre fw-semibold">@p.Nombre</td>
                            <td data-label="Tipo">@p.IdTipoProd</td>
                            <td data-label="Categoría">@p.IdCategoria</td>
                            <td data-label="Unidad">@p.IdUnidad</td>
                            <td data-label="Origen">@p.Origen</td>
                            <td data-label="Estado">
                                @{
                                    var estado = (p.Estado ?? "").ToUpperInvariant();
                                    var ok = estado == "ACTIVO";
                                }
                                <span class="badge @(ok ? "ok" : "danger")">@estado</span>
                            </td>
                            <td data-label="Creado">
                                @p.FechaCrea?.ToString("yyyy-MM-dd HH:mm")
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINACIÓN -->
    @if (totalPages > 1)
    {
        <nav aria-label="Paginación" class="pager">
            <!-- Anterior -->
            @if (hasPrev)
            {
                <a class="btn"
                   asp-action="Index" asp-route-q="@q" asp-route-page="@(currentPage - 1)">
                    Anterior
                </a>
            }
            else
            {
                <span class="btn" aria-disabled="true">Anterior</span>
            }

            @{
                // ventana de 5 páginas alrededor de la actual
                int start = Math.Max(1, currentPage - 2);
                int end = Math.Min(totalPages, currentPage + 2);

                if (start > 1)
                {
                    <a class="page @(currentPage == 1 ? "active" : "")"
                       asp-action="Index" asp-route-q="@q" asp-route-page="1">1</a>
                    if (start > 2)
                    {

                        <span class="page" aria-hidden="true">…</span>
                        ;
                    }
                }

                for (int i = start; i <= end; i++)
                {
                    <a class="page @(i == currentPage ? "active" : "")"
                       asp-action="Index" asp-route-q="@q" asp-route-page="@i">@i</a>
                }

                if (end < totalPages)
                {
                    if (end < totalPages - 1)
                    {

                        <span class="page" aria-hidden="true">…</span>
                        ;
                    }
                    <a class="page @(currentPage == totalPages ? "active" : "")"
                       asp-action="Index" asp-route-q="@q" asp-route-page="@totalPages">@totalPages</a>
                }
            }

            <!-- Siguiente -->
            @if (hasNext)
            {
                <a class="btn"
                   asp-action="Index" asp-route-q="@q" asp-route-page="@(currentPage + 1)">
                    Siguiente
                </a>
            }
            else
            {
                <span class="btn" aria-disabled="true">Siguiente</span>
            }
        </nav>
    }

    <div class="meta">
        Mostrando @items.Count de @totalItems ítems · Página @currentPage de @totalPages
    </div>
</div>
