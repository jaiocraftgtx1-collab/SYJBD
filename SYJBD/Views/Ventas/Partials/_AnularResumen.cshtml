@model SYJBD.Models.Ventas.AnularVentaPreviewVM
@{
    var anulada = (Model?.EstadoVenta ?? "").ToUpper() == "ANULADO"
               || (Model?.Estado ?? "").ToUpper() == "INACTIVO";
}

<div class="app-modal__header">
    <h5 class="m-0">Anular venta</h5>
    <!-- NO agregamos botón close aquí: el host ya trae su [data-modal-close] -->
</div>

<div id="app-modal-body" class="app-modal__body">
    @if (Model?.NotFound == true)
    {
        <div class="alert alert-danger mb-0">La venta no existe.</div>
    }
    else
    {
        <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6">
                <div class="small text-muted">Documento</div>
                <div class="fs-5 fw-semibold">@Model!.NumeroDoc</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Fecha:</div>
                <div>@Model.Fecha.ToString("yyyy-MM-dd HH:mm:ss")</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Total:</div>
                <div class="fw-semibold">S/ @Model.Total.ToString("N2")</div>
            </div>

            <div class="col-6 col-md-3">
                <div class="small text-muted">Estado venta:</div>
                <span class="badge bg-@(anulada ? "secondary" : "success")">@Model.EstadoVenta</span>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Estado Kardex:</div>
                <span class="badge bg-@(anulada ? "secondary" : "primary")">@Model.Estado</span>
            </div>

            <div class="col-12">
                <div class="alert alert-warning mb-2">
                    Se marcará la venta como <b>ANULADO / INACTIVO</b> y los movimientos de kárdex (SV) como <b>INACTIVO</b>.
                </div>
                <div class="small text-muted">Diagnóstico previo</div>
                <div>Ítems relacionados: <b>@Model.KardexSvActivos</b></div>
            </div>
        </div>
    }
</div>

<div class="app-modal__footer d-flex justify-content-end">
    @if (Model?.NotFound != true
        && (Model?.EstadoVenta ?? "").ToUpper() != "ANULADO"
        && (Model?.Estado ?? "").ToUpper() != "INACTIVO")
    {
        <button class="btn btn-danger"
                data-post-url="@Url.Action("Anular", "Ventas", new { id = Model!.IdVenta })"
                data-confirm="¿Confirmas que deseas ANULAR esta venta?">
            Sí, anular
        </button>

    }
</div>


<script>
    (() => {
      const btn = document.getElementById('btn-anular-confirm');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        // Reconfirmación mínima en el mismo modal
        if (!confirm('¿Confirmas que deseas ANULAR esta venta?')) return;

        const url = btn.getAttribute('data-url');
        try {
          // Usa TU loader global
          const r = await fetchWithLoader(url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });

          if (!r.ok) {
            const t = await r.text().catch(() => '');
            alert('No se pudo anular. ' + (t || r.statusText));
            return;
          }

          // Cerrar con el ÚNICO botón del host
          document.querySelector('#app-modal [data-modal-close]')?.click();
          // Refrescar la lista
          location.reload();

        } catch (e) {
          alert('Error al anular: ' + e);
        }
      }, { once: true });
    })();
</script>
