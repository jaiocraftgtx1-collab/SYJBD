@model SYJBD.Models.Ventas.VentaComprobanteVM
@{
    string nroDoc = string.IsNullOrWhiteSpace(Model.Serie)
        ? Model.Correlativo.ToString()
        : $"{Model.Serie}-{Model.Correlativo}";

    Func<string?, string> pill = s => (s ?? "").ToUpper() switch
    {
        "ATENDIDO" => "<span class='badge bg-success'>ATENDIDO</span>",
        "ANULADO" => "<span class='badge bg-danger'>ANULADO</span>",
        _ => $"<span class='badge bg-secondary'>{(s ?? "--")}</span>"
    };
}
@section Styles {
    <link rel="stylesheet" href="~/css/nuevaventa.css" asp-append-version="true" />
}

<div class="container-fluid py-2 nv-page">
    <!-- Encabezado -->
    <div class="d-flex align-items-start justify-content-between mb-2">
        <div>
            <h5 class="mb-1">Venta @nroDoc</h5>
            <div class="text-muted small">
                @Model.FechaVenta.ToString("dd/MM/yyyy HH:mm") ·
                <strong>@Model.TiendaNombre</strong> · Caja <strong>@Model.IdCaja</strong>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            @Html.Raw(pill(Model.EstadoVenta))
            <button type="button" class="btn btn-sm btn-outline-secondary" data-modal-close>Cerrar</button>
        </div>
    </div>

    <div class="row g-2">
        <!-- ===== DETALLE DE PRODUCTOS ===== -->
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm nv-card">
                <div class="card-body p-2 p-sm-3">
                    <div class="text-muted text-uppercase fw-bold small mb-2">DETALLE DE PRODUCTOS:</div>

                    <div class="table-responsive">
                        <table class="tbl-detalle table-sm align-middle mb-0">
                            <thead class="nv-th">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Talla</th>
                                    <th class="text-center">Und</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-center">P.U</th>
                                    <th class="text-end">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var it in Model.Items)
                                {
                                    <tr>
                                        <td class="det-prod">
                                            <div class="p-nom">@it.Nombre</div>
                                            <div class="p-sub text-muted">(@it.IdProducto)</div>
                                        </td>
                                        <td class="text-center">@it.IdTalla</td>
                                        <td class="text-center">@it.IdUnidad</td>
                                        <td class="text-center">@it.Cantidad.ToString("0.##")</td>
                                        <td class="text-center">@it.PrecioUnitario.ToString("N2")</td>
                                        <td class="text-end">@it.Total.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== RESUMEN / TOTALES / PAGO ===== -->
        <div class="col-12 col-lg-5">
            <div class="card shadow-sm nv-card">
                <div class="card-body p-3">

                    <!-- Cliente y documento -->
                    <div class="text-muted text-uppercase fw-bold small mb-2">DATOS DE VENTA</div>
                    <div class="row g-2 small mb-2">
                        <div class="col-6 text-muted">Cliente</div>
                        <div class="col-6 fw-semibold text-end">@Model.ClienteNombre</div>

                        <div class="col-6 text-muted">RUC/DNI</div>
                        <div class="col-6 text-end">@Model.ClienteRuc</div>

                        <div class="col-6 text-muted">Vendedor</div>
                        <div class="col-6 text-end">@Model.VendedorNombre</div>

                        <div class="col-6 text-muted">Documento</div>
                        <div class="col-6 text-end">@Model.TipoDocumento · <span class="fw-semibold">@nroDoc</span></div>
                    </div>

                    <hr class="my-3" />

                    <!-- Totales -->
                    <div class="nv-totals mb-2">
                        <div class="d-flex justify-content-between small">
                            <span>Subtotal</span><span>@Model.SubTotal.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>IGV (18%)</span><span>@Model.Igv.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between fs-6 fw-bold">
                            <span>Total</span><span>@Model.Total.ToString("N2")</span>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Método de pago -->
                    <div class="text-muted text-uppercase fw-semibold small mb-2">Método de pago</div>
                    <div class="small nv-pay">
                        @* ...tus filas de MP1 / MP2... *@
                        @if (!string.IsNullOrWhiteSpace(Model.MP1) && Model.MontoMP1 > 0)
                        {
                            <div class="d-flex justify-content-between">
                                <span>@Model.MP1</span><span>@Model.MontoMP1.ToString("N2")</span>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.MP2) && Model.MontoMP2 > 0)
                        {
                            <div class="d-flex justify-content-between">
                                <span>@Model.MP2</span><span>@Model.MontoMP2.ToString("N2")</span>
                            </div>
                        }
                    </div>


                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-primary flex-fill"
                           data-modal-url="@Url.Action("Imprimir", "Ventas", new { id = Model.IdVenta })">
                            <i class="bi bi-printer me-1"></i> IMPRIMIR
                        </a>

                        @if ((Model.EstadoVenta ?? "").ToUpper() != "ANULADO")
                        {
                            <a class="btn btn-outline-danger flex-fill"
                               data-modal-url="@Url.Action("AnularPreview", "Ventas", new { id = Model.IdVenta })">
                                <i class="bi bi-x-lg me-1"></i> ANULAR VENTA
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
